pipeline {
    agent {
        node {
            label 'java17'
        }
    
    }

    options {
                timestamps()
                buildDiscarder(logRotator(numToKeepStr: '5', artifactNumToKeepStr: '2'))
                timeout(time: 240, unit: 'MINUTES')
                disableConcurrentBuilds()
                }

        stages {

            stage ('AppCodeCheckout') {
                steps {

                    git 'https://github.com/Annaanil/final-project.git'

                }
            }
            stage ('CI Build') {

                steps {
                    
                     
                    sh 'mvn clean package'

                    

                     }
    
            }

            stage ('Docker Build && Push && RUN ') {
               

                steps {

                    withCredentials([string(credentialsId: 'DOCKER-PWD', variable: 'DOCKER_TOKEN')]) {
                
                    // some block

                    sh 'docker build . -t anilkumar0123456789/java17:latest'
                    sh 'docker login -u anilkumar0123456789 -p ${DOCKER_TOKEN}'
                    sh 'docker push anilkumar0123456789/java17:latest'
                    sh 'docker run -p 2022:8080 -d anilkumar0123456789/java17:latest'
                    }

                }    
                    
            }
            stage('archive and clean workspace') {
                steps {
                    
                    archiveArtifacts artifacts: 'target/anil-devops*.jar', followSymlinks: false
                    cleanWs()
                }
            }    
            stage ('k8s automate-checkout') {
                steps {

                    git 'https://github.com/Annaanil/k8s-manifes-files.git'

                }
            }
            stage ('k8s auto-deployment') {

                steps {

                    
                     sh 'kubectl --server=https://34.69.36.87 --insecure-skip-tls-verify --token="eyJhbGciOiJSUzI1NiIsImtpZCI6IjVyeURPOEtzSUxrNldaeGtOcVduNmRtV3ZmYUtBUjBVWXJNa2ZpS2ZrTVkifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImplbmtpbnMtc2EiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiamVua2lucyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImI3MzI5OWM1LTM1MjMtNDJhMy1hZDcyLWRiMzFjMTI0NTIxNCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmplbmtpbnMifQ.Gaos4VBrUJPm_-6tnSdpUQ5jO3w_Oq9WsI0oAhWDOn2yZxo5A98CnamMy8EokcsvwrBF9dHWeX7WqJvXfVJFAMyvqD-rblJMInZVdGpuK6iwUNbTOBH9UEz2NxCZncrjicu3gqqqo-s1ypOskuJRjJgqSY5MuKX6cVnavi479_ik_tgLIHAz9YNKA-0dFyCKt8t8-YN-2NCJ1xOz4KKcTOpyHuUzOu0IvjxswIV6r5bMgS9rAsXUSvR18GdgPuHqwUf_U6EBC11bDmDWskK4GZrRjpxRaRfrpih-oRG6DcAVwvAD0Fq5B_WMk2VSW18g3ortJsGA95RnSR1rYJHYiA" apply -f deployment.yml'
                     sh 'kubectl --server=https://34.69.36.87 --insecure-skip-tls-verify --token="eyJhbGciOiJSUzI1NiIsImtpZCI6IjVyeURPOEtzSUxrNldaeGtOcVduNmRtV3ZmYUtBUjBVWXJNa2ZpS2ZrTVkifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImplbmtpbnMtc2EiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiamVua2lucyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImI3MzI5OWM1LTM1MjMtNDJhMy1hZDcyLWRiMzFjMTI0NTIxNCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmplbmtpbnMifQ.Gaos4VBrUJPm_-6tnSdpUQ5jO3w_Oq9WsI0oAhWDOn2yZxo5A98CnamMy8EokcsvwrBF9dHWeX7WqJvXfVJFAMyvqD-rblJMInZVdGpuK6iwUNbTOBH9UEz2NxCZncrjicu3gqqqo-s1ypOskuJRjJgqSY5MuKX6cVnavi479_ik_tgLIHAz9YNKA-0dFyCKt8t8-YN-2NCJ1xOz4KKcTOpyHuUzOu0IvjxswIV6r5bMgS9rAsXUSvR18GdgPuHqwUf_U6EBC11bDmDWskK4GZrRjpxRaRfrpih-oRG6DcAVwvAD0Fq5B_WMk2VSW18g3ortJsGA95RnSR1rYJHYiA" apply -f service.yml'
                

             
                    echo "done"
                    sh 'kubectl get deployments'
                    sh 'kubectl get services'
                    cleanWs()
                
                }
            } 

        }

}             
    



            
              
                

                
            
    
